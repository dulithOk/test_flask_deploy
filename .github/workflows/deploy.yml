name: Deploy to PythonAnywhere (via API)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Trigger PythonAnywhere Deployment
      run: |
        curl -X POST https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}/consoles/ \
          -H "Authorization: Token ${{ secrets.PA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"executable": "/bin/bash"}' > response.json

        CONSOLE_ID=$(jq -r .id response.json)

        curl -X POST https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}/consoles/${CONSOLE_ID}/send_input/ \
          -H "Authorization: Token ${{ secrets.PA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{\"input\": \"cd ${{ secrets.PA_REPO_DIR }} && git pull origin main && touch /var/www/${{ secrets.PA_USERNAME }}_pythonanywhere_com_wsgi.py\\n\"}"

        sleep 10  # Allow some time for the command to run

        curl -X DELETE https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}/consoles/${CONSOLE_ID}/ \
          -H "Authorization: Token ${{ secrets.PA_API_TOKEN }}"

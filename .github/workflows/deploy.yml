name: Deploy to PythonAnywhere

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Start PythonAnywhere Console
      id: start_console
      run: |
        curl -X POST https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}/consoles/ \
          -H "Authorization: Token ${{ secrets.PA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"executable": "/bin/bash"}' > response.json
        cat response.json
        echo "console_id=$(jq -r .id response.json)" >> $GITHUB_OUTPUT

    - name: Wait for console to be ready
      run: |
        echo "Waiting for console to start..."
        sleep 10

    - name: Send commands to PythonAnywhere
      run: |
        curl -X POST https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}/consoles/${{ steps.start_console.outputs.console_id }}/send_input/ \
          -H "Authorization: Token ${{ secrets.PA_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{\"input\": \"cd ${{ secrets.PA_REPO_DIR }} && git pull origin main && touch /var/www/${{ secrets.PA_USERNAME }}_pythonanywhere_com_wsgi.py\\n\"}"

    - name: Close the console
      run: |
        curl -X DELETE https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}/consoles/${{ steps.start_console.outputs.console_id }}/ \
          -H "Authorization: Token ${{ secrets.PA_API_TOKEN }}"
